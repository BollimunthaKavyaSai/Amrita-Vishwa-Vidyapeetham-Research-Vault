<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <title>Search Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f172a] text-white font-sans min-h-screen">

  <!-- Header -->
  <header class="p-6 text-center">
    <h1 class="text-4xl font-extrabold text-cyan-400">üîç Search Results</h1>
    <p class="text-gray-300 mt-2" id="searchTermLabel"></p>
    <a href="homepage.html" onclick="preserveSearch()" class="inline-block mt-4 text-sm text-cyan-300 underline">
      ‚Üê Back to Home
    </a>
  </header>

  <!-- Paper Results -->
  <section class="mt-10 px-8 md:px-20">
    <div id="paperContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <!-- Cards will be injected here -->
    </div>
    <div id="loadingText" class="text-center text-gray-400 mt-6 hidden">Loading more papers...</div>
  </section>

  <!-- Scripts -->
  <script>
    function preserveSearch() {
      const params = new URLSearchParams(window.location.search);
      const term = params.get("term");
      if (term) sessionStorage.setItem("lastSearch", term);
    }

    const term = new URLSearchParams(window.location.search).get("term") || '';
    document.getElementById("searchTermLabel").innerText = `Results for: "${term}"`;

    let currentPage = 1;
    const limit = 12;
    let totalResults = 0;
    let loading = false;

    async function fetchPapers() {
      if (loading) return;
      loading = true;

      document.getElementById("loadingText").classList.remove("hidden");

      try {
        const response = await fetch(`http://localhost:3000/search?term=${encodeURIComponent(term)}&page=${currentPage}&limit=${limit}`);
        const data = await response.json();

        if (currentPage === 1 && data.total === 0) {
          document.getElementById("paperContainer").innerHTML = `<p class="text-center text-gray-400 col-span-full">No papers found.</p>`;
        } else {
          renderPapers(data.papers);  // ‚úÖ fixed here
          totalResults = data.total;
          currentPage++;
        }
      } catch (err) {
        console.error("Failed to load results:", err);
      } finally {
        loading = false;
        document.getElementById("loadingText").classList.add("hidden");
      }
    }

    function renderPapers(papers) {
      const container = document.getElementById("paperContainer");

      papers.forEach(paper => {
        container.innerHTML += `
          <div class="bg-[#1e293b] p-6 rounded-2xl shadow-xl border border-cyan-400/30">
            <h3 class="text-xl font-bold text-cyan-300">${paper.title}</h3>
            <p class="text-gray-300">Author: ${paper.author}</p>
            <p class="text-sm text-gray-400">Domain: ${paper.domain} | Year: ${paper.year}</p>
            <p class="mt-2 text-gray-200 text-sm">${paper.keywords}</p>
            <button class="mt-3 bg-cyan-500 hover:bg-cyan-600 px-4 py-1 rounded text-white text-sm">View</button>
          </div>
        `;
      });
    }

    // Load first batch
    fetchPapers();

    // Infinite scroll
    window.addEventListener("scroll", () => {
      const scrollBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
      const canLoadMore = (currentPage - 1) * limit < totalResults;

      if (scrollBottom && canLoadMore && !loading) {
        fetchPapers();
      }
    });
  </script>

</body>
</html>
